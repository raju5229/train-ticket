name: ci/cd pipeline to deploy to tomcat

on:
  push:
    branches:
      - master

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
          cache: 'maven'

      - name: Create secure Maven settings
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USER }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          mkdir -p $HOME/.m2
          umask 077
          cat > $HOME/.m2/settings.xml <<'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>nexus</id>
                <username>${env.NEXUS_USERNAME}</username>
                <password>${env.NEXUS_PASSWORD}</password>
              </server>
            </servers>
          </settings>
          EOF
          echo "Created ~/.m2/settings.xml (permissions: $(stat -c %a $HOME/.m2/settings.xml))"

      - name: Network reachability checks (Nexus + Tomcat)
        env:
          NEXUS_HOST: 34.227.67.34
          NEXUS_PORT: 8081
          TOMCAT_HOST: ${{ secrets.TOMCAT_HOST }}
          TOMCAT_PORT: 8080
        run: |
          set -e
          echo "Testing nexus HTTP endpoint..."
          # Try multiple times with backoff
          for i in 1 2 3; do
            echo "Attempt $i: curl -I http://${NEXUS_HOST}:${NEXUS_PORT}/"
            timeout 8 curl -I --max-time 8 http://${NEXUS_HOST}:${NEXUS_PORT}/ && break || sleep $((i*3))
            if [ $i -eq 3 ]; then
              echo "ERROR: Nexus HTTP not reachable from runner at ${NEXUS_HOST}:${NEXUS_PORT}"
              nc -vz ${NEXUS_HOST} ${NEXUS_PORT} || true
              exit 2
            fi
          done

          echo "Testing tomcat manager endpoint reachability..."
          timeout 8 curl -I --max-time 8 http://${TOMCAT_HOST}:${TOMCAT_PORT}/ || {
            echo "WARNING: Tomcat host ${TOMCAT_HOST}:${TOMCAT_PORT} not reachable from runner — tomcat deploy will fail"
          }

      - name: Validate, compile, test, package
        run: |
          mvn -B validate
          mvn -B -q compile
          mvn -B -q test || echo "Tests failed (non-blocking)"; true
          mvn -B -q package

      - name: Verify WAR file
        run: ls -lh target || true

      - name: Sonar (optional)
        if: ${{ secrets.SONAR_TOKEN != '' }}
        run: |
          mvn -B -DskipTests clean verify sonar:sonar \
            -Dsonar.projectKey=train-ticket-reservation \
            -Dsonar.host.url="${{ secrets.SONAR_HOST }}" \
            -Dsonar.login="${{ secrets.SONAR_TOKEN }}"

      - name: Publish WAR to Nexus (with debug on failure)
        run: |
          set -o pipefail
          echo "Running mvn deploy (will print debug on failure)"
          mvn -B deploy || { echo "mvn deploy failed — re-running with -X for debug"; mvn -X deploy; exit 1; }

      - name: Deploy WAR to Tomcat (manager script)
        env:
          TOMCAT_USER: ${{ secrets.TOMCAT_USER }}
          TOMCAT_PASSWORD: ${{ secrets.TOMCAT_PASSWORD }}
          TOMCAT_HOST: ${{ secrets.TOMCAT_HOST }}
        run: |
          WAR_FILE=$(ls target/*.war | head -n1)
          if [ -z "$WAR_FILE" ]; then
            echo "No WAR found in target/ — aborting"
            exit 1
          fi
          echo "Deploying $WAR_FILE to Tomcat manager on ${TOMCAT_HOST}:8080"
          # manager must have role 'manager-script' and the user configured in tomcat-users.xml
          curl -v --fail -u "${TOMCAT_USER}:${TOMCAT_PASSWORD}" -T "${WAR_FILE}" \
            "http://${TOMCAT_HOST}:8080/manager/text/deploy?path=/TrainBook&update=true" || {
              echo "Tomcat deploy failed; check manager user and reachability. Exiting."
              exit 1
            }
